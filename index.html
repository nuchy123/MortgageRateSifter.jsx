<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPO Go Rate Sheet Sifter</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo } = React;

    const MortgageRateSifter = () => {
      const [filters, setFilters] = useState({
        productType: 'all', loanType: 'all', lockPeriod: '30', fico: '', ltv: '',
        loanAmount: '', purchasePrice: '', occupancy: 'all', propertyType: 'singlefamily',
        loanPurpose: 'all', escrowWaiver: false, zipCode: '', state: '', city: ''
      });
      const [brokerComp, setBrokerComp] = useState(2.5);
      const [expandedRows, setExpandedRows] = useState({});

      const nyPrimaryPayups = {
        5.0: 0, 5.125: 0, 5.25: 0.096, 5.375: 0.096, 5.5: 0.095, 5.625: 0.095,
        5.75: 0.534, 5.875: 0.595, 6.0: 0.696, 6.125: 0.715, 6.25: 1.243,
        6.375: 1.257, 6.5: 1.416, 6.625: 1.527, 6.75: 2.356, 6.875: 2.396,
        7.0: 2.311, 7.125: 2.311, 7.25: 1.926, 7.375: 1.927, 7.49: 1.927
      };

      const getPayup = (rate, state, occupancy, product, term) => {
        if (product !== 'Conventional' || !term.includes('30')) return 0;
        if (state !== 'NY') return 0;
        const rates = Object.keys(nyPrimaryPayups).map(Number).sort((a,b) => a-b);
        let closest = rates[0];
        for (const r of rates) { if (Math.abs(r - rate) < Math.abs(closest - rate)) closest = r; }
        return nyPrimaryPayups[closest] || 0;
      };

      const zipDatabase = {
        '10952': {state:'NY',city:'Monsey'}, '10977': {state:'NY',city:'Spring Valley'},
        '10901': {state:'NY',city:'Suffern'}, '11201': {state:'NY',city:'Brooklyn'},
        '90001': {state:'CA',city:'Los Angeles'}, '60601': {state:'IL',city:'Chicago'},
        '75201': {state:'TX',city:'Dallas'}, '33101': {state:'FL',city:'Miami'},
        '07601': {state:'NJ',city:'Hackensack'}, '08701': {state:'NJ',city:'Lakewood'}
      };

      const rateData = [
        {product:'FHA',term:'30 Year Fixed',rate:4.5,lock15:95.938,lock30:95.813,lock45:95.688,lock60:95.563},
        {product:'FHA',term:'30 Year Fixed',rate:4.75,lock15:97.406,lock30:97.281,lock45:97.156,lock60:97.031},
        {product:'FHA',term:'30 Year Fixed',rate:5.0,lock15:98.742,lock30:98.617,lock45:98.492,lock60:98.367},
        {product:'FHA',term:'30 Year Fixed',rate:5.25,lock15:99.896,lock30:99.771,lock45:99.646,lock60:99.521},
        {product:'FHA',term:'30 Year Fixed',rate:5.5,lock15:100.976,lock30:100.851,lock45:100.726,lock60:100.601},
        {product:'FHA',term:'30 Year Fixed',rate:5.75,lock15:101.791,lock30:101.666,lock45:101.541,lock60:101.416},
        {product:'FHA',term:'30 Year Fixed',rate:6.0,lock15:102.128,lock30:102.003,lock45:101.878,lock60:101.753},
        {product:'FHA',term:'30 Year Fixed',rate:6.25,lock15:102.636,lock30:102.511,lock45:102.386,lock60:102.261},
        {product:'FHA',term:'30 Year Fixed',rate:6.5,lock15:103.031,lock30:102.906,lock45:102.781,lock60:102.656},
        {product:'FHA',term:'30 Year Fixed',rate:6.75,lock15:103.593,lock30:103.468,lock45:103.343,lock60:103.218},
        {product:'FHA',term:'30 Year Fixed',rate:7.0,lock15:104.34,lock30:104.215,lock45:104.09,lock60:103.965},
        {product:'FHA',term:'15 Year Fixed',rate:4.5,lock15:98.809,lock30:98.684,lock45:98.559,lock60:98.434},
        {product:'FHA',term:'15 Year Fixed',rate:5.0,lock15:100.287,lock30:100.162,lock45:100.037,lock60:99.912},
        {product:'FHA',term:'15 Year Fixed',rate:5.5,lock15:101.548,lock30:101.423,lock45:101.298,lock60:101.173},
        {product:'FHA',term:'15 Year Fixed',rate:6.0,lock15:102.669,lock30:102.544,lock45:102.419,lock60:102.294},
        {product:'VA',term:'30 Year Fixed',rate:4.5,lock15:95.788,lock30:95.663,lock45:95.538,lock60:95.413},
        {product:'VA',term:'30 Year Fixed',rate:5.0,lock15:98.592,lock30:98.467,lock45:98.342,lock60:98.217},
        {product:'VA',term:'30 Year Fixed',rate:5.5,lock15:100.826,lock30:100.701,lock45:100.576,lock60:100.451},
        {product:'VA',term:'30 Year Fixed',rate:6.0,lock15:101.978,lock30:101.853,lock45:101.728,lock60:101.603},
        {product:'VA',term:'30 Year Fixed',rate:6.25,lock15:102.586,lock30:102.461,lock45:102.336,lock60:102.211},
        {product:'VA',term:'15 Year Fixed',rate:4.5,lock15:98.559,lock30:98.434,lock45:98.309,lock60:98.184},
        {product:'VA',term:'15 Year Fixed',rate:5.0,lock15:99.974,lock30:99.849,lock45:99.724,lock60:99.599},
        {product:'VA',term:'15 Year Fixed',rate:5.5,lock15:101.198,lock30:101.073,lock45:100.948,lock60:100.823},
        {product:'VA',term:'15 Year Fixed',rate:6.0,lock15:102.319,lock30:102.194,lock45:102.069,lock60:101.944},
        {product:'USDA',term:'30 Year Fixed',rate:5.0,lock15:98.642,lock30:98.517,lock45:98.392,lock60:98.267},
        {product:'USDA',term:'30 Year Fixed',rate:5.5,lock15:100.876,lock30:100.751,lock45:100.626,lock60:100.501},
        {product:'USDA',term:'30 Year Fixed',rate:6.0,lock15:102.028,lock30:101.903,lock45:101.778,lock60:101.653},
        {product:'USDA',term:'30 Year Fixed',rate:6.5,lock15:102.931,lock30:102.806,lock45:102.681,lock60:102.556},
        {product:'USDA',term:'30 Year Fixed',rate:7.0,lock15:104.24,lock30:104.115,lock45:103.99,lock60:103.865},
        {product:'Conventional',term:'30 Year Fixed',rate:5.0,lock15:96.666,lock30:96.541,lock45:96.416,lock60:96.291},
        {product:'Conventional',term:'30 Year Fixed',rate:5.25,lock15:97.97,lock30:97.845,lock45:97.72,lock60:97.595},
        {product:'Conventional',term:'30 Year Fixed',rate:5.5,lock15:99.378,lock30:99.253,lock45:99.128,lock60:99.003},
        {product:'Conventional',term:'30 Year Fixed',rate:5.625,lock15:99.918,lock30:99.793,lock45:99.668,lock60:99.543},
        {product:'Conventional',term:'30 Year Fixed',rate:5.75,lock15:100.33,lock30:100.205,lock45:100.08,lock60:99.955},
        {product:'Conventional',term:'30 Year Fixed',rate:5.875,lock15:100.865,lock30:100.74,lock45:100.615,lock60:100.49},
        {product:'Conventional',term:'30 Year Fixed',rate:6.0,lock15:101.373,lock30:101.248,lock45:101.123,lock60:100.998},
        {product:'Conventional',term:'30 Year Fixed',rate:6.125,lock15:101.815,lock30:101.69,lock45:101.565,lock60:101.44},
        {product:'Conventional',term:'30 Year Fixed',rate:6.25,lock15:101.855,lock30:101.73,lock45:101.605,lock60:101.48},
        {product:'Conventional',term:'30 Year Fixed',rate:6.375,lock15:102.297,lock30:102.172,lock45:102.047,lock60:101.922},
        {product:'Conventional',term:'30 Year Fixed',rate:6.5,lock15:102.702,lock30:102.577,lock45:102.452,lock60:102.327},
        {product:'Conventional',term:'30 Year Fixed',rate:6.625,lock15:102.99,lock30:102.865,lock45:102.74,lock60:102.615},
        {product:'Conventional',term:'30 Year Fixed',rate:6.75,lock15:102.867,lock30:102.742,lock45:102.617,lock60:102.492},
        {product:'Conventional',term:'30 Year Fixed',rate:6.875,lock15:103.353,lock30:103.228,lock45:103.103,lock60:102.978},
        {product:'Conventional',term:'30 Year Fixed',rate:7.0,lock15:103.749,lock30:103.624,lock45:103.499,lock60:103.374},
        {product:'Conventional',term:'30 Year Fixed',rate:7.125,lock15:104.1,lock30:103.975,lock45:103.85,lock60:103.725},
        {product:'Conventional',term:'30 Year Fixed',rate:7.25,lock15:104.231,lock30:104.106,lock45:103.981,lock60:103.856},
        {product:'Conventional',term:'30 Year Fixed',rate:7.375,lock15:104.631,lock30:104.506,lock45:104.381,lock60:104.256},
        {product:'Conventional',term:'15 Year Fixed',rate:4.5,lock15:98.704,lock30:98.579,lock45:98.454,lock60:98.329},
        {product:'Conventional',term:'15 Year Fixed',rate:5.0,lock15:100.116,lock30:99.991,lock45:99.866,lock60:99.741},
        {product:'Conventional',term:'15 Year Fixed',rate:5.5,lock15:101.514,lock30:101.389,lock45:101.264,lock60:101.139},
        {product:'Conventional',term:'15 Year Fixed',rate:6.0,lock15:102.539,lock30:102.414,lock45:102.289,lock60:102.164},
        {product:'Conventional',term:'15 Year Fixed',rate:6.5,lock15:103.609,lock30:103.484,lock45:103.359,lock60:103.234},
        {product:'Conventional',term:'15 Year Fixed',rate:7.0,lock15:104.71,lock30:104.585,lock45:104.46,lock60:104.335}
      ];

      const states = [
        {code:'AL',name:'Alabama'},{code:'AZ',name:'Arizona'},{code:'CA',name:'California'},
        {code:'CO',name:'Colorado'},{code:'CT',name:'Connecticut'},{code:'DC',name:'DC'},
        {code:'DE',name:'Delaware'},{code:'FL',name:'Florida'},{code:'GA',name:'Georgia'},
        {code:'IL',name:'Illinois'},{code:'IN',name:'Indiana'},{code:'IA',name:'Iowa'},
        {code:'KY',name:'Kentucky'},{code:'LA',name:'Louisiana'},{code:'MA',name:'Massachusetts'},
        {code:'MD',name:'Maryland'},{code:'ME',name:'Maine'},{code:'MI',name:'Michigan'},
        {code:'MS',name:'Mississippi'},{code:'NC',name:'North Carolina'},{code:'NH',name:'New Hampshire'},
        {code:'NJ',name:'New Jersey'},{code:'NY',name:'New York'},{code:'OH',name:'Ohio'},
        {code:'OK',name:'Oklahoma'},{code:'OR',name:'Oregon'},{code:'PA',name:'Pennsylvania'},
        {code:'PR',name:'Puerto Rico'},{code:'RI',name:'Rhode Island'},{code:'SC',name:'South Carolina'},
        {code:'TN',name:'Tennessee'},{code:'TX',name:'Texas'},{code:'VA',name:'Virginia'},
        {code:'VT',name:'Vermont'},{code:'WA',name:'Washington'},{code:'WI',name:'Wisconsin'},
        {code:'WV',name:'West Virginia'}
      ];

      const handleFilterChange = (key, value) => {
        setFilters(prev => {
          const updated = {...prev, [key]: value};
          if (key === 'zipCode' && value.length === 5 && zipDatabase[value]) {
            updated.state = zipDatabase[value].state;
            updated.city = zipDatabase[value].city;
          }
          if (key === 'purchasePrice' && value && updated.ltv) {
            updated.loanAmount = Math.round(parseFloat(value) * parseFloat(updated.ltv) / 100);
          } else if (key === 'loanAmount' && value && updated.purchasePrice) {
            updated.ltv = ((parseFloat(value) / parseFloat(updated.purchasePrice)) * 100).toFixed(2);
          } else if (key === 'ltv' && value && updated.purchasePrice) {
            updated.loanAmount = Math.round(parseFloat(updated.purchasePrice) * parseFloat(value) / 100);
          }
          return updated;
        });
      };

      const calculatePriceAdjustments = (basePrice, product, rate, term) => {
        let adjustment = 0;
        const breakdown = [];
        const fico = parseInt(filters.fico);
        const ltv = parseFloat(filters.ltv);
        const loanAmount = parseFloat(filters.loanAmount);
        const state = filters.state;

        // State adjustment for Conventional
        if (state && product === 'Conventional') {
          let stateAdj = 0;
          if (['AL','CO','DC','DE','GA','IA','IN','LA','MD','ME','MI','MS','NH','NY','OK','TN','VT','WI','WV'].includes(state)) stateAdj = 0;
          else if (['AZ','CA','KY','NC','OH','OR','PA','RI','SC','VA','WA'].includes(state)) stateAdj = 0.1;
          else if (state === 'TX') stateAdj = 0.15;
          else if (['CT','FL','MA','IL'].includes(state)) stateAdj = 0.2;
          else if (state === 'NJ') stateAdj = 0.325;
          else if (state === 'PR') stateAdj = -0.15;
          if (stateAdj !== 0) { adjustment += stateAdj; breakdown.push({label:'State: '+state, value:stateAdj}); }
        }

        // FICO x LTV for Conventional Purchase
        if (product === 'Conventional' && filters.loanPurpose === 'purchase' && fico && ltv) {
          let ficoLtvAdj = 0;
          if (ltv > 75 && ltv <= 80) {
            if (fico >= 780) ficoLtvAdj = -0.375;
            else if (fico >= 760) ficoLtvAdj = -0.625;
            else if (fico >= 740) ficoLtvAdj = -0.875;
            else if (fico >= 720) ficoLtvAdj = -1.25;
            else if (fico >= 700) ficoLtvAdj = -1.375;
            else if (fico >= 680) ficoLtvAdj = -1.75;
            else if (fico >= 660) ficoLtvAdj = -1.875;
            else ficoLtvAdj = -2.25;
          } else if (ltv > 70 && ltv <= 75) {
            if (fico >= 780) ficoLtvAdj = 0;
            else if (fico >= 760) ficoLtvAdj = -0.25;
            else if (fico >= 740) ficoLtvAdj = -0.375;
            else if (fico >= 720) ficoLtvAdj = -0.75;
            else ficoLtvAdj = -0.875;
          } else if (ltv > 60 && ltv <= 70) {
            if (fico >= 760) ficoLtvAdj = 0;
            else if (fico >= 740) ficoLtvAdj = -0.125;
            else if (fico >= 720) ficoLtvAdj = -0.25;
            else ficoLtvAdj = -0.375;
          }
          if (ficoLtvAdj !== 0) { adjustment += ficoLtvAdj; breakdown.push({label:'FICO x LTV', value:ficoLtvAdj}); }
        }

        // Condo LLPA
        if (filters.propertyType === 'condo' && product === 'Conventional') {
          adjustment += -0.75; breakdown.push({label:'Condo LLPA', value:-0.75});
        }

        // Fixed Amortization credit
        if (product === 'Conventional') {
          adjustment += 0.125; breakdown.push({label:'Fixed Amortization', value:0.125});
        }

        // Pay-up incentive
        const payup = getPayup(rate, state, filters.occupancy, product, term);
        if (payup !== 0) { adjustment += payup; breakdown.push({label:'Pay-Up Incentive', value:payup}); }

        return {adjustment, adjustedPrice: basePrice + adjustment, breakdown};
      };

      const filteredData = useMemo(() => {
        const filtered = rateData.filter(item => {
          const matchesProduct = filters.productType === 'all' || item.product === filters.productType;
          const matchesTerm = filters.loanType === 'all' || item.term === filters.loanType;
          return matchesProduct && matchesTerm;
        });

        const withCosts = filtered.map(item => {
          const basePrice = item['lock' + filters.lockPeriod] || item.lock30;
          const calcResult = calculatePriceAdjustments(basePrice, item.product, item.rate, item.term);
          const priceAfterBrokerComp = calcResult.adjustedPrice - brokerComp;
          let discountRebate = 0;
          if (filters.loanAmount) {
            discountRebate = (100 - priceAfterBrokerComp) * parseFloat(filters.loanAmount) / 100;
          }
          const monthlyRate = item.rate / 100 / 12;
          const numPayments = 360;
          const principal = parseFloat(filters.loanAmount) || 0;
          const monthlyPayment = principal > 0 ? principal * (monthlyRate * Math.pow(1+monthlyRate,numPayments)) / (Math.pow(1+monthlyRate,numPayments)-1) : 0;
          const totalCost = discountRebate + (monthlyPayment * 360 - principal);
          return {...item, basePrice, calcResult, priceAfterBrokerComp, discountRebate, monthlyPayment, totalCost};
        });

        let bestIdx = -1, lowestCost = Infinity;
        if (filters.loanAmount) {
          withCosts.forEach((item, i) => { if (item.totalCost < lowestCost) { lowestCost = item.totalCost; bestIdx = i; }});
        }
        return withCosts.map((item, i) => ({...item, isBestOption: i === bestIdx && filters.loanAmount}));
      }, [filters, brokerComp]);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h1 className="text-2xl font-bold text-gray-800">TPO Go Rate Sheet Sifter</h1>
              <p className="text-gray-600">Effective Date: 12/24/2025</p>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h2 className="text-lg font-semibold mb-4">Filters</h2>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Product</label>
                  <select value={filters.productType} onChange={e => handleFilterChange('productType', e.target.value)} className="w-full p-2 border rounded">
                    <option value="all">All</option>
                    <option value="FHA">FHA</option>
                    <option value="VA">VA</option>
                    <option value="USDA">USDA</option>
                    <option value="Conventional">Conventional</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Term</label>
                  <select value={filters.loanType} onChange={e => handleFilterChange('loanType', e.target.value)} className="w-full p-2 border rounded">
                    <option value="all">All</option>
                    <option value="30 Year Fixed">30 Year</option>
                    <option value="15 Year Fixed">15 Year</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Lock Period</label>
                  <select value={filters.lockPeriod} onChange={e => handleFilterChange('lockPeriod', e.target.value)} className="w-full p-2 border rounded">
                    <option value="15">15-Day</option>
                    <option value="30">30-Day</option>
                    <option value="45">45-Day</option>
                    <option value="60">60-Day</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">ZIP Code</label>
                  <input type="text" value={filters.zipCode} onChange={e => handleFilterChange('zipCode', e.target.value)} placeholder="10952" maxLength="5" className="w-full p-2 border rounded" />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">State</label>
                  <select value={filters.state} onChange={e => handleFilterChange('state', e.target.value)} className="w-full p-2 border rounded">
                    <option value="">Select</option>
                    {states.map(s => <option key={s.code} value={s.code}>{s.name}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">FICO</label>
                  <input type="number" value={filters.fico} onChange={e => handleFilterChange('fico', e.target.value)} placeholder="750" className="w-full p-2 border rounded" />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Purchase Price</label>
                  <input type="number" value={filters.purchasePrice} onChange={e => handleFilterChange('purchasePrice', e.target.value)} placeholder="800000" className="w-full p-2 border rounded" />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">LTV %</label>
                  <input type="number" value={filters.ltv} onChange={e => handleFilterChange('ltv', e.target.value)} placeholder="80" className="w-full p-2 border rounded" />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Loan Amount</label>
                  <input type="number" value={filters.loanAmount} onChange={e => handleFilterChange('loanAmount', e.target.value)} placeholder="640000" className="w-full p-2 border rounded" />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Broker Comp %</label>
                  <input type="number" step="0.125" value={brokerComp} onChange={e => setBrokerComp(parseFloat(e.target.value) || 0)} className="w-full p-2 border rounded" />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Loan Purpose</label>
                  <select value={filters.loanPurpose} onChange={e => handleFilterChange('loanPurpose', e.target.value)} className="w-full p-2 border rounded">
                    <option value="all">All</option>
                    <option value="purchase">Purchase</option>
                    <option value="rateterm">Rate/Term Refi</option>
                    <option value="cashout">Cash-Out Refi</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Property Type</label>
                  <select value={filters.propertyType} onChange={e => handleFilterChange('propertyType', e.target.value)} className="w-full p-2 border rounded">
                    <option value="singlefamily">Single Family</option>
                    <option value="condo">Condo</option>
                    <option value="2-4unit">2-4 Units</option>
                  </select>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-lg font-semibold mb-4">Results ({filteredData.length})</h2>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-indigo-50">
                    <tr>
                      <th className="p-3 text-left">Product</th>
                      <th className="p-3 text-left">Term</th>
                      <th className="p-3 text-center">Rate</th>
                      <th className="p-3 text-center">Price</th>
                      <th className="p-3 text-center">Adjustments</th>
                      {filters.loanAmount && <th className="p-3 text-center">Disc/Rebate</th>}
                      {filters.loanAmount && <th className="p-3 text-center">Monthly P&I</th>}
                      {filters.loanAmount && <th className="p-3 text-center">Total Cost</th>}
                    </tr>
                  </thead>
                  <tbody>
                    {filteredData.map((item, i) => (
                      <React.Fragment key={i}>
                        <tr className={item.isBestOption ? 'bg-yellow-50 border-2 border-yellow-400' : 'border-b hover:bg-gray-50'}>
                          <td className="p-3">
                            <span className={`px-2 py-1 rounded text-xs font-semibold ${
                              item.product === 'FHA' ? 'bg-blue-100 text-blue-800' :
                              item.product === 'VA' ? 'bg-green-100 text-green-800' :
                              item.product === 'USDA' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-purple-100 text-purple-800'
                            }`}>{item.product}</span>
                            {item.isBestOption && <span className="ml-2 px-2 py-1 rounded text-xs font-bold bg-yellow-400">BEST</span>}
                          </td>
                          <td className="p-3">{item.term}</td>
                          <td className="p-3 text-center font-semibold">{item.rate.toFixed(3)}%</td>
                          <td className="p-3 text-center">
                            <span className={`font-bold ${item.priceAfterBrokerComp >= 100 ? 'text-green-600' : 'text-red-600'}`}>
                              {item.priceAfterBrokerComp.toFixed(3)}
                            </span>
                          </td>
                          <td className="p-3 text-center">
                            <span className={item.calcResult.adjustment >= 0 ? 'text-green-600' : 'text-red-600'}>
                              {item.calcResult.adjustment >= 0 ? '+' : ''}{item.calcResult.adjustment.toFixed(3)}
                            </span>
                            {item.calcResult.breakdown.length > 0 && (
                              <button onClick={() => setExpandedRows(prev => ({...prev, [i]: !prev[i]}))} className="ml-2 text-xs text-indigo-600 underline">
                                {expandedRows[i] ? 'hide' : 'details'}
                              </button>
                            )}
                          </td>
                          {filters.loanAmount && (
                            <td className="p-3 text-center">
                              <span className={item.discountRebate < 0 ? 'text-green-600' : 'text-red-600'}>
                                ${Math.abs(item.discountRebate).toLocaleString('en-US', {maximumFractionDigits: 0})}
                              </span>
                              <div className="text-xs text-gray-500">{item.discountRebate < 0 ? 'Credit' : 'Cost'}</div>
                            </td>
                          )}
                          {filters.loanAmount && <td className="p-3 text-center">${item.monthlyPayment.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>}
                          {filters.loanAmount && <td className="p-3 text-center font-bold">${item.totalCost.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>}
                        </tr>
                        {expandedRows[i] && (
                          <tr><td colSpan="8" className="p-3 bg-gray-50">
                            <div className="text-sm max-w-md">
                              <div className="font-semibold mb-2">Breakdown:</div>
                              {item.calcResult.breakdown.map((b, j) => (
                                <div key={j} className="flex justify-between">
                                  <span>{b.label}:</span>
                                  <span className={b.value >= 0 ? 'text-green-600' : 'text-red-600'}>{b.value >= 0 ? '+' : ''}{b.value.toFixed(3)}</span>
                                </div>
                              ))}
                              <div className="border-t mt-2 pt-2">
                                <div className="flex justify-between"><span>Base:</span><span>{item.basePrice.toFixed(3)}</span></div>
                                <div className="flex justify-between"><span>Adjusted:</span><span>{item.calcResult.adjustedPrice.toFixed(3)}</span></div>
                                <div className="flex justify-between text-red-600"><span>Broker:</span><span>-{brokerComp.toFixed(3)}</span></div>
                                <div className="flex justify-between font-bold"><span>Net:</span><span>{item.priceAfterBrokerComp.toFixed(3)}</span></div>
                              </div>
                            </div>
                          </td></tr>
                        )}
                      </React.Fragment>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="mt-6 bg-indigo-600 text-white rounded-lg p-4 text-center">
              <p>TPO Go Wholesale | Lock Desk: (860) 676-8003 | tpogo.com</p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<MortgageRateSifter />);
  </script>
</body>
</html>
